---
title: "Gridding point data by Kriging"
author: "Marko Laine FMI"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  \VignetteIndexEntry{Gridding point data by Kriging}
  \VignetteEngine{knitr::rmarkdown}
  \VignetteEncoding{UTF-8}
---

This document describes gridding of point observations to a regular grid. The code is mainly intended for interpolating station temperatures (or other meterological variables). The code can use a prior backgroud model field.

## Mathematical background 

The gridding can be described as an hierarchical linear model

\begin{equation}
  \label{equ:hiermodel}
  \begin{split}
  y|\eta &\sim N(H\eta,\Sigma_y), \qquad\text{observations}\\
  \eta|\beta &\sim N(X\beta,\Sigma_\eta), \qquad\text{spatial random field}\\
  \beta &\sim N(\beta_0,\Sigma_\beta)  \qquad\text{hyper parameters}
  \end{split}
\end{equation}

$B$ is the spatial covariance matrix.

The Kriging prediction equation gives estimates for

\begin{equation}
  y_\mathrm{pred}   = x_\mathrm{pred}\widehat{\beta} + b B^{-1} (y - X\widehat{\beta})
\end{equation}

$b$ is a row vector correlations between the new location and the observation locations.

## Code details

The essential parts of the fortran code is the following

```fortran
  call chol(b, nobs)               ! replace B with L = chol(B,â€™lower')
  call ldivide(b,x, nobs, npar)    ! replace x with inv(L)*x
  call ldivide(b,y, nobs, 1)       ! replace y with inv(L)*y
  call lsq(x,y,beta, nobs, npar)   ! solve x from y=x*beta
  call resid(x,y,beta, nobs, npar) ! y = y - x*beta
  call ltdivide(b,y, nobs, 1)      ! y = inv(L')*y
  ! calculate prediction over grid
  do i=1, ngrid
     x1 = grid(i,:)
     call corrdist(cgrid(i,:),cy,b1, nobs, covpars)
     ypred(i) = matmul(x1,beta) + matmul(b1,y)
  end do
```



## Examples


```{r}
library('fastgrid')
lonmin <- 19.0; lonmax <- 33.0; latmin <- 59.0; latmax <- 71.5
londx <- 0.4; latdx <- 0.1
modelgrid <- makelonlatgrid(lonmin=lonmin,lonmax=lonmax,latmin=latmin,latmax=latmax,londx=londx,latdx=latdx)
```

Some random points in the defined region as a SpatialPointsDataFrame
```{r}
nobs <- 50
obs <- data.frame(longitude=runif(nobs,lonmin,lonmax),
                  latitude=runif(nobs,latmin,latmax),
                  temperature=rnorm(nobs,mean=10,sd=4))
sp::coordinates(obs) <- c('longitude','latitude')
```

Interpolate to model grid by Kriging.
```{r}
cov.pars <- c(1.0^2,1.0,0.1) # sigma2, correlation length, nugget
t0<-proc.time()
obs.gridded <- pointgridding(pointdata=obs,modelgrid=modelgrid,cov.pars=cov.pars,variable="temperature")
print(t1<-proc.time()-t0)
```
```{r}
library(sp)
library(maps)
library(maptools)
library(ggplot2)
spplot(obs.gridded)

```

```{r fig.height=5}
MOSplotting::MOS_plot_field(obs.gridded,stations=obs,cmin=0,cmax=20,main='kriging interpolation')

```



## Figures

```{r, fig.show='hold',fig.cap="Caption",eval=FALSE}

```



---
title: "Gridding point data by Kriging"
author: "Marko Laine"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  \VignetteIndexEntry{Gridding point data by Kriging}
  \VignetteEngine{knitr::rmarkdown}
  \VignetteEncoding{UTF-8}
---

DUMMY text, still, sorry.

This document describes grdding of point observations to a regular grid. The code is intended to grid station temperatures (or other meterological variables) to a grid. The code can use a prior backgroud model. The code was done as the default Kriging in the pakage gstat was so slow.


## Examples

```{r, eval=FALSE, include=TRUE}
library(MOSfieldutils)
stationsfile<- system.file("extdata","201706061910_MOS_2017060612_6_2017060618.csv",package="MOSfieldutils")
ECMWFbgfile <- system.file("extdata","1715712000006.nc",package="MOSfieldutils")
mtitle <- '2016-05-17 12Z 06h forecast'
stations <- MOSstation_csv_load(stationsfile)
ECMWFbg <- ECMWF_bg_load(ECMWFbgfile)
mosfield <- MOSgrid(stations = stations, bgfield = ECMWFbg)
```


```{r, fig.show='hold', eval=FALSE, include=TRUE}
MOS_plot_field(mosfield, stations = stations, layer = "diff", main = mtitle)
```


## Code details

The essential parts of the fortran code is the following

```fortran
  call chol(b, nobs)               ! replace B with L = chol(B,â€™lower')
  call ldivide(b,x, nobs, npar)    ! replace x with L\x
  call ldivide(b,y, nobs, 1)       ! replace y with L\y
  call lsq(x,y,beta, nobs, npar)   ! beta = x\y
  call resid(x,y,beta, nobs, npar) ! y = y - x*beta
  call ltdivide(b,y, nobs, 1)      ! y = L'\y
  ! calculate prediction over grid
  do i=1, ngrid
     x1 = grid(i,:)
     call corrdist(cgrid(i,:),cy,b1, nobs, covpars)
     ypred(i) = matmul(x1,beta) + matmul(b1,y)
  end do
```

## Mathematical background 

Basically, the gridding can be described as

\begin{equation}
  \label{equ:hiermodel}
  \begin{split}
  y|\eta &\sim N(H\eta,\Sigma_y), \qquad\text{observations}\\
  \eta|\beta &\sim N(X\beta,\Sigma_\eta), \qquad\text{spatial random field}\\
  \beta &\sim N(\beta_0,\Sigma_\beta)  \qquad\text{hyper parameters}
  \end{split}
\end{equation}


## Figures

```{r, fig.show='hold',fig.cap="Caption",eval=FALSE}
MOS_plot_field(out)
```


